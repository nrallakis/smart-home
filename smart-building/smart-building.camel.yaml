- route:
    id: ha-to-fiware
    from:
      id: from664a
      uri: kafka
      parameters:
        brokers: broker:29092
        groupId: fiware-mapper
        topic: home_assistant_states
      steps:
        - unmarshal:
            id: unmarshal086b
            json:
              id: json2496
              library: Jackson
        - setBody:
            id: setBody4b33
            expression:
              groovy:
                id: groovy485f
                expression: |
                  def message = body instanceof List ? body[0] : body
                  def data = message?.value ?: message
                  if (data == null || data.attributes == null) { return null }

                  def attr = data.attributes
                  def entityId = data.entity_id
                  def rawDate = data.last_updated ?: "2026-01-01T00:00:00Z"
                  def cleanDate = rawDate.contains(".") ? rawDate.split("\\.")[0] + "Z" : rawDate
                  def fiwareId = "urn:ngsi-ld:DeviceMeasurement:${entityId}"

                  headers['CamelKafkaKey'] = entityId
                  // This header is used for the dynamic topic name below
                  headers['targetTopic'] = attr.device_class ?: "unknown"

                  return [
                    "id": fiwareId,
                    "type": "DeviceMeasurement",
                    "name": attr.friendly_name ?: "Unknown",
                    "measurementType": headers['targetTopic'],
                    "numValue": data.state?.isNumber() ? data.state.toDouble() : 0.0,
                    "unit": attr.unit_of_measurement ?: "",
                    "dateObserved": cleanDate
                  ]
        - filter:
            id: filterb1bd
            expression:
              simple:
                id: simple3c5d
                expression: ${body} != null
            steps:
              - marshal:
                  id: marshalf9d1
                  json:
                    id: jsonb881
                    library: Jackson
              - convertBodyTo:
                  id: convertBodyTo423a
                  type: java.lang.String
              - toD:
                  id: toDa016
                  uri: kafka:${header.targetTopic}?brokers=broker:29092
              - removeHeader:
                  id: removeHeader3752
                  name: targetTopic
